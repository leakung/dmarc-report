{% extends "base.html" %}

{% block title %}Dashboard - DMARC Analyzer{% endblock %}

{% block content %}
<h1 style="margin-bottom: 1.5rem;">üìä Dashboard Overview</h1>

<!-- Overall Statistics -->
<div class="stats-grid">
    <div class="stat-card">
        <h3>Total Reports</h3>
        <div class="value">{{ overall_stats.total_reports or 0 }}</div>
        <div class="subtext">
            {% if overall_stats.first_report_date %}
            Since {{ overall_stats.first_report_date|datetime }}
            {% endif %}
        </div>
    </div>
    
    <div class="stat-card">
        <h3>Monitored Domains</h3>
        <div class="value">{{ overall_stats.total_domains or 0 }}</div>
    </div>
    
    <div class="stat-card">
        <h3>Total Messages</h3>
        <div class="value">{{ '{:,}'.format(overall_stats.total_messages or 0) }}</div>
    </div>
    
    <div class="stat-card">
        <h3>Unique Source IPs</h3>
        <div class="value">{{ '{:,}'.format(overall_stats.total_source_ips or 0) }}</div>
    </div>
</div>

<!-- Charts Row -->
<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; margin-bottom: 1.5rem;">
    {% if disposition_stats %}
    <div class="card">
        <h2>Message Disposition Distribution</h2>
        <div class="chart-container">
            <canvas id="dispositionChart"></canvas>
        </div>
    </div>
    {% endif %}
    
    <div class="card">
        <h2>Last 30 Days Trend</h2>
        <div class="chart-container">
            <canvas id="timelineChart"></canvas>
        </div>
    </div>
</div>

{% if disposition_stats %}
<div class="card">
    <h2>Message Disposition Breakdown</h2>
    <table>
        <thead>
            <tr>
                <th>Disposition</th>
                <th>Count</th>
                <th>Percentage</th>
            </tr>
        </thead>
        <tbody>
            {% set total = disposition_stats|sum(attribute='total') %}
            {% for stat in disposition_stats %}
            <tr>
                <td>
                    {% if stat.disposition == 'none' %}
                    <span class="badge badge-success">{{ stat.disposition }}</span>
                    {% elif stat.disposition == 'quarantine' %}
                    <span class="badge badge-warning">{{ stat.disposition }}</span>
                    {% else %}
                    <span class="badge badge-danger">{{ stat.disposition }}</span>
                    {% endif %}
                </td>
                <td>{{ '{:,}'.format(stat.total) }}</td>
                <td>
                    <div class="progress-bar">
                        <div class="progress-fill {% if stat.disposition == 'none' %}success{% elif stat.disposition == 'quarantine' %}warning{% else %}danger{% endif %}" 
                             style="width: {{ (stat.total / total * 100)|int }}%">
                            {{ '%.1f'|format(stat.total / total * 100) }}%
                        </div>
                    </div>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% endif %}

{% if domain_stats %}
<div class="card">
    <h2>Top Domains</h2>
    <table>
        <thead>
            <tr>
                <th>Domain</th>
                <th>Reports</th>
                <th>Messages</th>
                <th>Passed</th>
                <th>Quarantined</th>
                <th>Rejected</th>
                <th>Last Report</th>
            </tr>
        </thead>
        <tbody>
            {% for domain in domain_stats %}
            <tr>
                <td><a href="/domain/{{ domain.domain }}">{{ domain.domain }}</a></td>
                <td>{{ domain.total_reports }}</td>
                <td>{{ '{:,}'.format(domain.total_messages) }}</td>
                <td><span class="badge badge-success">{{ '{:,}'.format(domain.passed_messages) }}</span></td>
                <td><span class="badge badge-warning">{{ '{:,}'.format(domain.quarantined_messages) }}</span></td>
                <td><span class="badge badge-danger">{{ '{:,}'.format(domain.rejected_messages) }}</span></td>
                <td>{{ domain.last_report_date|datetime }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% endif %}

<!-- Filter and Search Section -->
<div class="card">
    <h2>üîç All Reports
        <a href="/export/reports" class="btn btn-success" style="float: right; text-decoration: none;">üì• Export CSV</a>
    </h2>
    
    <form method="get" action="/" class="filter-section" style="margin-top: 1rem;">
        <div class="filter-grid">
            <div class="form-group">
                <label for="search">Search</label>
                <input type="text" id="search" name="search" value="{{ search }}" 
                       placeholder="Report ID, Organization, Domain...">
            </div>
            
            <div class="form-group">
                <label for="domain">Domain</label>
                <select id="domain" name="domain">
                    <option value="">All Domains</option>
                    {% for d in all_domains %}
                    <option value="{{ d }}" {% if domain_filter == d %}selected{% endif %}>{{ d }}</option>
                    {% endfor %}
                </select>
            </div>
            
            <div class="form-group">
                <label for="org">Organization</label>
                <select id="org" name="org">
                    <option value="">All Organizations</option>
                    {% for o in all_orgs %}
                    <option value="{{ o }}" {% if org_filter == o %}selected{% endif %}>{{ o }}</option>
                    {% endfor %}
                </select>
            </div>
            
            <div class="form-group">
                <label for="date_from">Date From</label>
                <input type="date" id="date_from" name="date_from" value="{{ date_from }}">
            </div>
            
            <div class="form-group">
                <label for="date_to">Date To</label>
                <input type="date" id="date_to" name="date_to" value="{{ date_to }}">
            </div>
        </div>
        
        <div class="filter-actions">
            <button type="submit" class="btn btn-primary">üîç Apply Filters</button>
            <a href="/" class="btn btn-secondary">üîÑ Clear</a>
            <small style="margin-left: auto;">Showing {{ recent_reports|length }} of {{ total_filtered }} filtered reports</small>
        </div>
    </form>
    
    {% if recent_reports %}
    <table style="margin-top: 1rem;">
        <thead>
            <tr>
                <th>ID</th>
                <th>Organization</th>
                <th>Domain</th>
                <th>Date Range</th>
                <th>Records</th>
                <th>Messages</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for report in recent_reports %}
            <tr>
                <td><a href="/report/{{ report.report_id }}">#{{ report.id }}</a></td>
                <td>{{ report.org_name }}</td>
                <td><a href="/domain/{{ report.domain }}">{{ report.domain }}</a></td>
                <td>
                    {{ report.date_range_begin|datetime }}<br>
                    <small>to {{ report.date_range_end|datetime }}</small>
                </td>
                <td>{{ report.record_count }}</td>
                <td>{{ '{:,}'.format(report.message_count or 0) }}</td>
                <td>
                    <a href="/report/{{ report.report_id }}" class="btn btn-primary" style="padding: 0.25rem 0.75rem; text-decoration: none;">View</a>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    
    <!-- Pagination -->
    {% if total_pages > 1 %}
    <div class="pagination">
        {% if page > 1 %}
        <a href="?page={{ page - 1 }}{% if search %}&search={{ search }}{% endif %}{% if domain_filter %}&domain={{ domain_filter }}{% endif %}{% if org_filter %}&org={{ org_filter }}{% endif %}{% if date_from %}&date_from={{ date_from }}{% endif %}{% if date_to %}&date_to={{ date_to }}{% endif %}">‚Äπ Previous</a>
        {% else %}
        <span class="disabled">‚Äπ Previous</span>
        {% endif %}
        
        <span style="margin: 0 10px;">
            Page 
            <select id="pageSelect" style="padding: 5px 10px; border: 1px solid #ddd; border-radius: 4px; background: white; cursor: pointer;">
                {% for p in range(1, total_pages + 1) %}
                <option value="{{ p }}" {% if p == page %}selected{% endif %}>{{ p }}</option>
                {% endfor %}
            </select>
            of {{ total_pages }}
        </span>
        
        {% if page < total_pages %}
        <a href="?page={{ page + 1 }}{% if search %}&search={{ search }}{% endif %}{% if domain_filter %}&domain={{ domain_filter }}{% endif %}{% if org_filter %}&org={{ org_filter }}{% endif %}{% if date_from %}&date_from={{ date_from }}{% endif %}{% if date_to %}&date_to={{ date_to }}{% endif %}">Next ‚Ä∫</a>
        {% else %}
        <span class="disabled">Next ‚Ä∫</span>
        {% endif %}
    </div>
    
    <script>
    document.getElementById('pageSelect').addEventListener('change', function() {
        var page = this.value;
        var url = '?page=' + page;
        {% if search %}url += '&search={{ search }}';{% endif %}
        {% if domain_filter %}url += '&domain={{ domain_filter }}';{% endif %}
        {% if org_filter %}url += '&org={{ org_filter }}';{% endif %}
        {% if date_from %}url += '&date_from={{ date_from }}';{% endif %}
        {% if date_to %}url += '&date_to={{ date_to }}';{% endif %}
        window.location.href = url;
    });
    </script>
    {% endif %}
    
    {% else %}
    <p style="text-align: center; padding: 2rem; color: #7f8c8d;">No reports found matching your filters.</p>
    {% endif %}
</div>

{% if not overall_stats.total_reports %}
<div class="card">
    <h2>üöÄ Getting Started</h2>
    <p>No DMARC reports have been imported yet. Start by:</p>
    <ul style="margin-left: 2rem; margin-top: 1rem;">
        <li>Configuring the IMAP fetcher to automatically retrieve reports</li>
        <li>Using the manual import script to import local files</li>
    </ul>
</div>
{% endif %}

{% endblock %}

{% block extra_js %}
{% if disposition_stats %}
// Disposition Pie Chart
const dispositionCtx = document.getElementById('dispositionChart').getContext('2d');
const dispositionChart = new Chart(dispositionCtx, {
    type: 'pie',
    data: {
        labels: [
            {% for stat in disposition_stats %}
            '{{ stat.disposition|capitalize }}'{% if not loop.last %},{% endif %}
            {% endfor %}
        ],
        datasets: [{
            data: [
                {% for stat in disposition_stats %}
                {{ stat.total }}{% if not loop.last %},{% endif %}
                {% endfor %}
            ],
            backgroundColor: [
                {% for stat in disposition_stats %}
                {% if stat.disposition == 'none' %}'#27ae60'{% elif stat.disposition == 'quarantine' %}'#f39c12'{% else %}'#e74c3c'{% endif %}{% if not loop.last %},{% endif %}
                {% endfor %}
            ]
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                position: 'bottom'
            }
        }
    }
});
{% endif %}

// Timeline Chart
fetch('/api/timeline?days=30')
    .then(response => response.json())
    .then(data => {
        const timelineCtx = document.getElementById('timelineChart').getContext('2d');
        const timelineChart = new Chart(timelineCtx, {
            type: 'line',
            data: {
                labels: data.map(d => d.report_date),
                datasets: [
                    {
                        label: 'Passed',
                        data: data.map(d => d.passed),
                        borderColor: '#27ae60',
                        backgroundColor: 'rgba(39, 174, 96, 0.1)',
                        tension: 0.4
                    },
                    {
                        label: 'Quarantined',
                        data: data.map(d => d.quarantined),
                        borderColor: '#f39c12',
                        backgroundColor: 'rgba(243, 156, 18, 0.1)',
                        tension: 0.4
                    },
                    {
                        label: 'Rejected',
                        data: data.map(d => d.rejected),
                        borderColor: '#e74c3c',
                        backgroundColor: 'rgba(231, 76, 60, 0.1)',
                        tension: 0.4
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom'
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });
    });
{% endblock %}
